{% extends "learn.html" %}

{% block title %}Multi Learning{% endblock %}

{% block learn %}

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
        padding: 20px;
    }

    .text-center {
        text-align: center;
    }

    .mb-4 {
        margin-bottom: 1.5rem;
    }

    .no-margin {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }

    .card {
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .card-header {
        background-color: #007bff;
        color: white;
        padding: 10px;
        border-radius: 8px 8px 0 0;
    }

    .card-body {
        padding: 20px;
    }

    .droppable {
        padding: 5px;
        border-bottom: 2px dashed #007bff;
        margin-right: 5px;
        display: inline-block;
        min-width: 50px;
        text-align: center;
        cursor: pointer;
    }

    .image-option {
        padding: 5px 10px;
        background-color: #007bff;
        color: white;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        display: inline-block;
        user-select: none;
    }

    .image-option:hover {
        background-color: #0056b3;
    }

    .correct {
        font-weight: bold;
        color: green;
    }

    .word-button {
        background-color: transparent;
        border: none;
        color: #007bff;
        cursor: pointer;
        padding: 0;
        font-size: inherit;
    }

    .word-button:focus {
        outline: none;
    }

    .selected {
        background-color: #d1e7ff;
    }

    .translation-bubble {
        position: absolute;
        background-color: #007bff;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
    }
</style>

<h1 class="text-center mb-4">Uzupełnianie brakujących słów w tekście</h1>

<div class="container no-margin">
    <div class="row justify-content-center no-margin">
        <div class="col-md-8 no-margin">
            <div class="card mt-5 no-margin">
                <div class="card-header">
                    <h2 class="row justify-content-center">Wybierz odpowiednie słowa i przeciągnij je na właściwe miejsce</h2>
                </div>
                <div class="card-body">
                    <p id="text-with-blanks"></p>
                    <div id="image-container" class="row justify-content-center"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Modal for Word Translation -->
<div class="modal fade" id="translationModal" tabindex="-1" aria-labelledby="translationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="translationModalLabel">Tłumaczenie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-content">
                <!-- Translation content will be injected here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal remains the same -->
<div class="modal fade" id="translationModal" tabindex="-1" aria-labelledby="translationModalLabel" aria-hidden="true">
    <!-- Modal content is the same -->
</div>

{% include 'learning/controls/buttons.html' %}
{% include 'learning/modals/edit-word-modal.html' %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('/user/get_text_data')
        .then(response => response.json())
        .then(data => {
            const textContainer = document.getElementById('text-with-blanks');
            const wordContainer = document.getElementById('image-container');

            let isMouseDown = false;
            let selectedWords = [];
            let lastSelectedIndex = -1;
            let actionBubble = null;

            const wordCount = data.texts[0].sentences.reduce((count, sentence) => {
                sentence.missing_words.forEach(missingWord => {
                    const word = missingWord.word;
                    count[word] = (count[word] || 0) + 1;
                });
                return count;
            }, {});

            let fullTextHtml = '';
            data.texts[0].sentences.forEach((sentence, sentenceIndex) => {
                let sentenceHtml = '';
                let words = sentence.english.split(' ');
                let positionIndex = 0;

                while (positionIndex < words.length) {
                    const word = words[positionIndex];

                    // Znajdź missingWord w oparciu o pozycję
                    const missingWord = sentence.missing_words.find(mw => {
                        const isMultiplePositions = Array.isArray(mw.position);
                        return isMultiplePositions
                            ? mw.position.includes(positionIndex + 1)
                            : mw.position === positionIndex + 1;
                    });

                    if (missingWord) {
                        const missingWordLength = missingWord.word.split(' ').length;
                        sentenceHtml += `<span class="droppable word-button" data-word="${missingWord.word}" data-index="${sentenceIndex}-${positionIndex}">____</span> `;
                        
                        // Przeskocz wszystkie pozycje, które zajmuje missingWord
                        positionIndex += missingWordLength;
                    } else {
                        // Sprawdzenie, czy słowo powinno być pominięte, ponieważ należy do missingWord
                        const isPartOfMissingWord = sentence.missing_words.some(mw => {
                            if (Array.isArray(mw.position)) {
                                return mw.position.includes(positionIndex + 1);
                            }
                            return false;
                        });

                        if (!isPartOfMissingWord) {
                            sentenceHtml += `<button class="word-button" data-word="${word}" data-index="${sentenceIndex}-${positionIndex}">${word}</button> `;
                        }

                        positionIndex += 1;
                    }
                }

                fullTextHtml += sentenceHtml.trim() + ' ';
            });

            textContainer.innerHTML = fullTextHtml.trim();

            const createDraggableWord = (word) => {
                const wordElement = document.createElement('div');
                wordElement.classList.add('image-option');
                wordElement.innerText = word;
                wordElement.draggable = true;
                wordElement.ondragstart = drag;
                wordContainer.appendChild(wordElement);
            };

            const updateWordContainer = () => {
                wordContainer.innerHTML = '';
                Object.keys(wordCount).forEach(word => {
                    if (wordCount[word] > 0 && !usedWords.has(word)) {
                        for (let i = 0; i < wordCount[word]; i++) {
                            createDraggableWord(word);
                        }
                    }
                });
            };

            const usedWords = new Set();
            updateWordContainer();

            // Obsługa zaznaczania i odznaczania słów
            textContainer.addEventListener('mousedown', function(event) {
                if (event.target.classList.contains('word-button')) {
                    isMouseDown = true;
                    toggleSelection(event.target);
                    updateBubble(event);
                }
            });

            textContainer.addEventListener('mouseover', function(event) {
                if (isMouseDown && event.target.classList.contains('word-button')) {
                    toggleSelection(event.target);
                    updateBubble(event);
                }
            });

            textContainer.addEventListener('mouseup', function(event) {
                isMouseDown = false;
                if (selectedWords.length > 0) {
                    updateBubble(event, true);
                }
            });

            document.addEventListener('mouseup', function() {
                isMouseDown = false;
            });

            function toggleSelection(element) {
                const word = element.dataset.word;
                const wordIndex = element.dataset.index;

                if (selectedWords.length === 0 || wordIndex === `${lastSelectedIndex.split('-')[0]}-${parseInt(lastSelectedIndex.split('-')[1]) + 1}`) {
                    element.classList.add('selected');
                    selectedWords.push(word);
                    lastSelectedIndex = wordIndex;
                } else if (element.classList.contains('selected')) {
                    element.classList.remove('selected');
                    selectedWords = selectedWords.filter(w => w !== word);
                    lastSelectedIndex = selectedWords.length > 0 ? element.dataset.index : -1;
                }

                if (selectedWords.length === 0 && actionBubble) {
                    actionBubble.style.display = 'none';
                }
            }            

            function updateBubble(event, finalizePosition = false) {
                const firstSelectedWord = document.querySelector('.selected');
                if (selectedWords.length > 0 && firstSelectedWord) {
                    const rect = firstSelectedWord.getBoundingClientRect();
                    const x = rect.left;
                    const y = rect.top - 40;

                    if (!actionBubble) {
                        actionBubble = document.createElement('div');
                        actionBubble.id = 'action-bubble';
                        actionBubble.style.position = 'absolute';
                        actionBubble.style.padding = '10px';
                        actionBubble.style.border = '1px solid #ccc';
                        actionBubble.style.borderRadius = '5px';
                        actionBubble.style.backgroundColor = '#fff';
                        actionBubble.style.boxShadow = '0px 2px 5px rgba(0,0,0,0.2)';
                        actionBubble.innerHTML = `
                            <button id="translateButton">Tłumacz</button>
                            <span id="previewTranslation"></span>
                        `;
                        document.body.appendChild(actionBubble);

                        document.getElementById('translateButton').addEventListener('click', function() {
                            const translation = selectedWords
                                .map(word => {
                                    const translationObj = data.texts[0].sentences
                                        .flatMap(sentence => sentence.missing_words)
                                        .find(mw => mw.word === word);
                                    return translationObj ? translationObj.translation : 'Brak tłumaczenia';
                                })
                                .join(', ');
                            showTranslation(translation);
                            actionBubble.style.display = 'none';
                        });
                    }

                    actionBubble.style.left = `${x}px`;
                    actionBubble.style.top = `${y}px`;
                    actionBubble.style.display = 'block';

                    if (finalizePosition) {
                        const previewTranslation = selectedWords
                            .map(word => {
                                const translationObj = data.texts[0].sentences
                                    .flatMap(sentence => sentence.missing_words)
                                    .find(mw => mw.word === word);
                                return translationObj ? translationObj.translation : 'Brak tłumaczenia';
                            })
                            .join(', ');
                        document.getElementById('previewTranslation').innerText = ` | ${previewTranslation}`;
                    }
                }
            }

            function showTranslation(translation) {
                document.getElementById('modal-body-content').innerText = translation;
                const modal = new bootstrap.Modal(document.getElementById('translationModal'));
                modal.show();
            }

            // Obsługa przeciągania i upuszczania
            function allowDrop(event) {
                event.preventDefault();
            }

            function drag(event) {
                event.dataTransfer.setData('text', event.target.innerText);
            }

            function drop(event) {
                event.preventDefault();
                const draggedWord = event.dataTransfer.getData('text');
                const target = event.target;

                if (target.classList.contains('droppable') && draggedWord === target.dataset.word) {
                    target.innerText = draggedWord;
                    target.classList.add('correct');
                    target.classList.remove('droppable');
                    target.classList.add('word-button');

                    wordCount[draggedWord]--;
                    if (wordCount[draggedWord] <= 0) {
                        usedWords.add(draggedWord);
                        updateWordContainer();
                    }

                    checkCompletion();
                }
            }

            function checkCompletion() {
                const remainingDroppables = document.querySelectorAll('.droppable');
                if (remainingDroppables.length === 0) {
                    alert('Gratulacje! Wszystkie słowa zostały wstawione.');
                }
            }

            // Obsługa urządzeń dotykowych (mobile)
            textContainer.addEventListener('touchstart', function(event) {
                if (event.target.classList.contains('word-button')) {
                    toggleSelection(event.target);
                    updateBubble(event.touches[0]);
                }
            });

            textContainer.addEventListener('touchmove', function(event) {
                const touch = event.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element && element.classList.contains('word-button')) {
                    toggleSelection(element);
                    updateBubble(touch);
                }
            });

            textContainer.addEventListener('touchend', function(event) {
                if (selectedWords.length > 0) {
                    updateBubble(event.changedTouches[0], true);
                }
            });

            document.addEventListener('dragover', allowDrop);
            document.addEventListener('drop', drop);
        });
});

</script>
{% endblock %}
