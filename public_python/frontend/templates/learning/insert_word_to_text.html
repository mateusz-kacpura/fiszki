{% extends "learn.html" %}

{% block title %}Multi Learning{% endblock %}

{% block learn %}

<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='project/css/learning.css') }}">

<div class="row justify-content-center">
    <!-- Lewa kolumna z kartą i wyborem słów -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header text-center">
                <h2 class="card-title">Wybierz odpowiednie słowa i przeciągnij je na właściwe miejsce</h2>
            </div>
            <div class="card-body">
                <p id="text-with-blanks"></p>
                <div id="image-container" class="d-flex justify-content-center flex-wrap"></div>
            </div>
        </div>
    </div>

    <!-- Prawa kolumna z historią tłumaczeń -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header text-center">
                <h2 class="card-title">Historia tłumaczeń</h2>
            </div>
            <div class="card-body">
                <ul id="translation-history"></ul> <!-- Tutaj będzie wyświetlana historia tłumaczeń -->
                <button id="clear-history" class="btn btn-sm btn-danger mt-3">Wyczyść historię</button>
                <button id="save-history-to-file" class="btn btn-sm btn-success mt-3">Zapisz historię</button>
                <button id="load-history-from-file" class="btn btn-sm btn-primary mt-3">Wczytaj historię</button>
            </div>
            <div class="card-footer text-center">
            <p class="m-0">ENTER = save changes </p>
            </div>
        </div>
    </div>

    <!-- Miejsce na dynamiczne powiadomienia (alerty) -->
    <div id="alert-container" style="position: fixed; top: 10px; right: 10px; z-index: 1000;"></div>

</div>


<!-- Bootstrap Modal for Word Translation -->
<div class="modal fade" id="translationModal" tabindex="-1" aria-labelledby="translationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="translationModalLabel">Tłumaczenie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-content">
                <!-- Translation content will be injected here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal remains the same -->
<div class="modal fade" id="translationModal" tabindex="-1" aria-labelledby="translationModalLabel" aria-hidden="true">
    <!-- Modal content is the same -->
</div>

<div class="modal fade" id="textSelectionModal" tabindex="-1" aria-labelledby="textSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="textSelectionModalLabel">Wybierz tekst</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul id="textList" class="list-group">
                    <!-- Lista tekstów zostanie wygenerowana dynamicznie -->
                </ul>
            </div>
        </div>
    </div>
</div>


{% include 'learning/controls/buttons.html' %}
{% include 'learning/modals/edit-word-modal.html' %}

{% endblock %}

{% block scripts %}
<script>
let selectedTextName = ""

// Funkcja do wyświetlania alertów
function showAlert(message, type = 'success') {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerText = message;
    alertContainer.appendChild(alert);

    // Usunięcie alertu po 3 sekundach
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    
    decideWhichTextToLoad();
    
    // Generowanie listy tekstów do wyboru
    function decideWhichTextToLoad() {
        fetch('/user/get_text_data')
            .then(response => response.json())
            .then(data => {
                const textList = document.getElementById('textList');

                data.text_names.forEach(text => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item list-group-item-action';
                    listItem.dataset.name = text.name;
                    listItem.innerText = text.name;
                    listItem.addEventListener('click', function() {
                        selectedTextName = this.dataset.name;
                        fetchAndLoadText(selectedTextName);
                    });
                    textList.appendChild(listItem);
                });

                // Pokazanie modala po załadowaniu listy tekstów
                const textSelectionModal = new bootstrap.Modal(document.getElementById('textSelectionModal'));
                textSelectionModal.show();
            })
            .catch(error => {
                console.error('Błąd przy pobieraniu listy tekstów:', error);
            });
    }

    // Funkcja zarządzająca tekstem
    function fetchAndLoadText(textName) {
        fetch(`/user/get_text_data?name=${encodeURIComponent(textName)}`)
            .then(response => response.json())
            .then(data => {
                const textContainer = document.getElementById('text-with-blanks');
                const wordContainer = document.getElementById('image-container');

                let isMouseDown = false;
                let selectedWords = [];
                let lastSelectedIndex = -1;
                let actionBubble = null;

                const wordCount = data.texts[0].sentences.reduce((count, sentence) => {
                    sentence.missing_words.forEach(missingWord => {
                        const word = missingWord.word;
                        count[word] = (count[word] || 0) + 1;
                    });
                    return count;
                }, {});

                let fullTextHtml = '';
                data.texts[0].sentences.forEach((sentence, sentenceIndex) => {
                    let sentenceHtml = '';
                    let words = sentence.english.split(' ');
                    let positionIndex = 0;

                    while (positionIndex < words.length) {
                        const word = words[positionIndex];

                        const missingWord = sentence.missing_words.find(mw => {
                            const isMultiplePositions = Array.isArray(mw.position);
                            return isMultiplePositions
                                ? mw.position.includes(positionIndex + 1)
                                : mw.position === positionIndex + 1;
                        });

                        if (missingWord) {
                            const missingWordLength = missingWord.word.split(' ').length;
                            sentenceHtml += `<span class="droppable word-button" data-word="${missingWord.word}" data-index="${sentenceIndex}-${positionIndex}">____</span> `;
                            
                            positionIndex += missingWordLength;
                        } else {
                            const isPartOfMissingWord = sentence.missing_words.some(mw => {
                                if (Array.isArray(mw.position)) {
                                    return mw.position.includes(positionIndex + 1);
                                }
                                return false;
                            });

                            if (!isPartOfMissingWord) {
                                sentenceHtml += `<button class="word-button" data-word="${word}" data-index="${sentenceIndex}-${positionIndex}">${word}</button> `;
                            }

                            positionIndex += 1;
                        }
                    }

                    fullTextHtml += sentenceHtml.trim() + ' ';
                });

                textContainer.innerHTML = fullTextHtml.trim();

            const createDraggableWord = (word) => {
                const wordElement = document.createElement('div');
                wordElement.classList.add('image-option');
                wordElement.innerText = word;
                wordElement.draggable = true;
                wordElement.ondragstart = drag;
                wordContainer.appendChild(wordElement);
            };

            const updateWordContainer = () => {
                wordContainer.innerHTML = '';
                Object.keys(wordCount).forEach(word => {
                    if (wordCount[word] > 0 && !usedWords.has(word)) {
                        for (let i = 0; i < wordCount[word]; i++) {
                            createDraggableWord(word);
                        }
                    }
                });
            };

            const usedWords = new Set();
            updateWordContainer();

            // Obsługa zaznaczania i odznaczania słów
            textContainer.addEventListener('mousedown', function(event) {
                if (event.target.classList.contains('word-button')) {
                    isMouseDown = true;
                    toggleSelection(event.target);
                    updateBubble(event);
                }
            });

            textContainer.addEventListener('mouseover', function(event) {
                if (isMouseDown && event.target.classList.contains('word-button')) {
                    toggleSelection(event.target);
                    updateBubble(event);
                }
            });

            textContainer.addEventListener('mouseup', function(event) {
                isMouseDown = false;
                if (selectedWords.length > 0) {
                    updateBubble(event, true);
                }
            });

            document.addEventListener('mouseup', function() {
                isMouseDown = false;
            });

            function toggleSelection(element) {
                const word = element.dataset.word;
                const wordIndex = element.dataset.index;

                if (selectedWords.length === 0 || wordIndex === `${lastSelectedIndex.split('-')[0]}-${parseInt(lastSelectedIndex.split('-')[1]) + 1}`) {
                    element.classList.add('selected');
                    selectedWords.push(word);
                    lastSelectedIndex = wordIndex;
                } else if (element.classList.contains('selected')) {
                    element.classList.remove('selected');
                    selectedWords = selectedWords.filter(w => w !== word);
                    lastSelectedIndex = selectedWords.length > 0 ? element.dataset.index : -1;
                }

                if (selectedWords.length === 0 && actionBubble) {
                    actionBubble.style.display = 'none';
                }
            }            

            function updateBubble(event, finalizePosition = false) {
                const firstSelectedWord = document.querySelector('.selected');
                if (selectedWords.length > 0 && firstSelectedWord) {
                    const rect = firstSelectedWord.getBoundingClientRect();
                    const x = rect.left;
                    const y = rect.top - 40;

                    if (!actionBubble) {
                        actionBubble = document.createElement('div');
                        actionBubble.id = 'action-bubble';
                        actionBubble.style.position = 'absolute';
                        actionBubble.style.padding = '10px';
                        actionBubble.style.border = '1px solid #ccc';
                        actionBubble.style.borderRadius = '5px';
                        actionBubble.style.backgroundColor = '#fff';
                        actionBubble.style.boxShadow = '0px 2px 5px rgba(0,0,0,0.2)';
                        actionBubble.innerHTML = `
                            <button id="translateButton">Tłumacz</button>
                            <button id="selectSentenceButton">Zaznacz całe zdanie</button>
                            <button id="clearSelectionButton">Usuń zaznaczenie</button>
                            <span id="previewTranslation"></span>
                        `;
                        document.body.appendChild(actionBubble);

                        // Event listener dla przycisku tłumaczenia
                        document.getElementById('translateButton').addEventListener('click', function() {
                            const textToTranslate = selectedWords.join(' ');

                            // Wykonaj fetch do Twojego API
                            fetch('/user/translate', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ text: textToTranslate }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.translatedText) {
                                    showTranslation(data.translatedText);
                                    updateTranslationHistory(textToTranslate, data.translatedText);
                                } else {
                                    showTranslation('Brak tłumaczenia');
                                }
                                actionBubble.style.display = 'none';
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showTranslation('Błąd tłumaczenia');
                                actionBubble.style.display = 'none';
                            });
                        });

                        // Event listener dla przycisku zaznaczania całego zdania
                        document.getElementById('selectSentenceButton').addEventListener('click', function() {
                            selectEntireSentence();
                        });

                        // Event listener dla przycisku usuwania zaznaczeń
                        document.getElementById('clearSelectionButton').addEventListener('click', function() {
                            clearSelections();
                        });
                    }

                    actionBubble.style.left = `${x}px`;
                    actionBubble.style.top = `${y}px`;
                    actionBubble.style.display = 'block';

                    if (finalizePosition) {
                        document.getElementById('previewTranslation').innerText = '';
                    }
                }
            }

            // Obsługa przycisku wczytywania historii z pliku
            document.getElementById('load-history-from-file').addEventListener('click', function() {
                fetch('/user/load_translation_history_from_file?name=' + encodeURIComponent(selectedTextName))
                    .then(response => response.json())
                    .then(data => {
                        const translationHistory = document.getElementById('translation-history');
                        translationHistory.innerHTML = '';  // Wyczyść obecne elementy listy

                        if (data.translations && data.translations.length > 0) {
                            data.translations.forEach(function(translation) {
                                updateTranslationHistory(translation.originalText, translation.translatedText);
                            });
                            showAlert('Historia tłumaczeń została pomyślnie wczytana.', 'success');
                        } else {
                            showAlert('Brak zapisanych tłumaczeń dla wybranego pliku.', 'warning');
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        showAlert('Wystąpił błąd podczas wczytywania historii tłumaczeń.', 'danger');
                    });
            });
            
            // Funkcja do wykonania zapytania do Google Translate API v1 bez klucza
            async function translateText(text, targetLang = 'en') {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    showAlert('Tłumaczenie wykonane pomyślnie');
                    return data[0][0][0];  // Zwracany przetłumaczony tekst
                } catch (error) {
                    console.error('Błąd tłumaczenia:', error);
                    showAlert('Błąd tłumaczenia', 'danger');
                    return 'Błąd tłumaczenia';
                }
            }

            // Funkcja aktualizująca historię tłumaczeń
            function updateTranslationHistory(originalText, translatedText) {
                const historyList = document.getElementById('translation-history');

                // Tworzenie nowego elementu listy
                const newEntry = document.createElement('li');
                newEntry.innerHTML = `
                    <span class="editable">${originalText} - ${translatedText}</span>
                    <button class="delete-btn btn btn-sm btn-danger ml-2">Usuń</button>
                    <button class="retranslate-btn btn btn-sm btn-primary ml-2">Tłumacz google</button>
                `;

                // Dodaj do listy
                historyList.appendChild(newEntry);
                showAlert('Dodano nowe tłumaczenie');

                // Event listener do bezpośredniego edytowania wpisu po kliknięciu
                const editableSpan = newEntry.querySelector('.editable');
                editableSpan.addEventListener('click', function () {
                    // Sprawdzanie czy już jest w trybie edycji
                    if (!this.isContentEditable) {
                        this.contentEditable = true;
                        this.focus();
                    }
                });

                // Zapisywanie zmian po wyjściu z trybu edycji
                editableSpan.addEventListener('blur', function () {
                    this.contentEditable = false;
                    showAlert('Zapisano zmiany');
                });

                // Zatrzymywanie edycji po wciśnięciu klawisza Enter
                editableSpan.addEventListener('keydown', function (event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        this.blur(); // Wyłączenie trybu edycji
                    }
                });

                // Event listener do usuwania wpisu
                newEntry.querySelector('.delete-btn').addEventListener('click', function() {
                    historyList.removeChild(newEntry);
                    showAlert('Usunięto tłumaczenie', 'info');
                });

                // Event listener do ponownego tłumaczenia
                newEntry.querySelector('.retranslate-btn').addEventListener('click', async function() {
                    const newTranslation = await translateText(originalText, 'pl'); // Tłumaczenie na polski
                    editableSpan.innerText = `${originalText} - ${newTranslation}`;
                    showAlert('Zaktualizowano tłumaczenie przez Google');
                });
            }

            // Funkcja czyszczenia całej historii
            document.getElementById('clear-history').addEventListener('click', function() {
                const historyList = document.getElementById('translation-history');
                historyList.innerHTML = ''; // Usuwa wszystkie elementy
                showAlert('Wyczyszczono całą historię', 'warning');
            });

            function selectEntireSentence() {
                const firstSelectedWord = document.querySelector('.selected');
                if (firstSelectedWord) {
                    // Znajdź najbliższy element .word-button, aby określić początek zdania
                    const sentenceElement = firstSelectedWord.closest('.card-body').querySelectorAll('.word-button');

                    if (sentenceElement) {
                        let startIndex = Array.from(sentenceElement).indexOf(firstSelectedWord);
                        let selectedSentence = [];

                        if (startIndex !== -1) {
                            // Zaznacz całe zdanie od początkowego do końcowego indeksu
                            for (let i = startIndex; i < sentenceElement.length; i++) {
                                const wordElement = sentenceElement[i];
                                if (wordElement.dataset.index.split('-')[0] !== firstSelectedWord.dataset.index.split('-')[0]) {
                                    break;
                                }
                                wordElement.classList.add('selected');
                                selectedSentence.push(wordElement.dataset.word);
                            }

                            // Złóż zdanie z zaznaczonych słów
                            let sentenceString = selectedSentence.join(' ');

                            // Szukaj, czy nowe zdanie zawiera się w już istniejących, lub je rozszerza
                            let wasUpdated = false;
                            selectedWords = selectedWords.map(existingSentence => {
                                // Jeśli istnieje już fragment nowego zdania w istniejącym
                                if (sentenceString.startsWith(existingSentence)) {
                                    // Dodajemy brakującą część do istniejącego zdania
                                    wasUpdated = true;
                                    return existingSentence.split(' ')[0] + sentenceString.slice(existingSentence.length);
                                } else if (existingSentence.startsWith(sentenceString)) {
                                    // Jeśli całe nowe zdanie jest już częścią istniejącego, nic nie robimy
                                    wasUpdated = true;
                                    return existingSentence;
                                }
                            });

                            // Jeśli zdanie nie zostało dodane ani rozszerzone, dodaj nowe zdanie
                            if (!wasUpdated) {
                                selectedWords.push(sentenceString);
                            }
                        }
                    }
                }
            }

            function clearSelections() {
                // Funkcja do usuwania wszystkich zaznaczeń
                document.querySelectorAll('.selected').forEach(word => {
                    word.classList.remove('selected');
                });
                selectedWords = [];
                actionBubble.style.display = 'none';
            }

            function showTranslation(translation) {
                document.getElementById('modal-body-content').innerText = translation;
                const modal = new bootstrap.Modal(document.getElementById('translationModal'));
                modal.show();
            }


            // Obsługa przeciągania i upuszczania
            function allowDrop(event) {
                event.preventDefault();
            }

            function drag(event) {
                event.dataTransfer.setData('text', event.target.innerText);
            }

            function drop(event) {
                event.preventDefault();
                const draggedWord = event.dataTransfer.getData('text');
                const target = event.target;

                if (target.classList.contains('droppable') && draggedWord === target.dataset.word) {
                    target.innerText = draggedWord;
                    target.classList.add('correct');
                    target.classList.remove('droppable');
                    target.classList.add('word-button');

                    wordCount[draggedWord]--;
                    if (wordCount[draggedWord] <= 0) {
                        usedWords.add(draggedWord);
                        updateWordContainer();
                    }

                    checkCompletion();
                }
            }

            function checkCompletion() {
                const remainingDroppables = document.querySelectorAll('.droppable');
                if (remainingDroppables.length === 0) {
                    alert('Gratulacje! Wszystkie słowa zostały wstawione.');
                }
            }

            // Obsługa urządzeń dotykowych (mobile)
            textContainer.addEventListener('touchstart', function(event) {
                if (event.target.classList.contains('word-button')) {
                    toggleSelection(event.target);
                    updateBubble(event.touches[0]);
                }
            });

            textContainer.addEventListener('touchmove', function(event) {
                const touch = event.touches[0];
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element && element.classList.contains('word-button')) {
                    toggleSelection(element);
                    updateBubble(touch);
                }
            });

            textContainer.addEventListener('touchend', function(event) {
                if (selectedWords.length > 0) {
                    updateBubble(event.changedTouches[0], true);
                }
            });

            document.addEventListener('dragover', allowDrop);
            document.addEventListener('drop', drop);
        });
    }
    
});

document.getElementById('save-history-to-file').addEventListener('click', function() {
    const translations = [];

    document.querySelectorAll('#translation-history li').forEach(function(item) {
        const originalText = item.querySelector('.editable').textContent.split(' - ')[0].trim();
        const translatedText = item.querySelector('.editable').textContent.split(' - ')[1].trim();

        translations.push({
            "originalText": originalText,
            "translatedText": translatedText,
            "metadata": {
                "translationSource": "manual"  // Wartość domyślna, można zmienić
            }
        });
    });

    fetch('/user/save_history_translation?name=' + encodeURIComponent(selectedTextName), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ translations: translations }),
    })
    .then(response => response.json())
    .then(data => {
        console.log('Success:', data);
    })
    .catch((error) => {
        console.error('Error:', error);
    });
});



</script>
{% endblock %}
